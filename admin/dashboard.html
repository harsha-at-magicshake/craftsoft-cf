<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Abhi's Craftsoft</title>
    <meta name="description" content="Admin Dashboard - Abhi's Craftsoft">
    <meta name="robots" content="noindex, nofollow">

    <!-- Security: No Cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Admin Styles -->
    <link rel="stylesheet" href="css/admin.css">
</head>

<body>
    <div class="admin-layout">
        <!-- Header -->
        <header class="admin-header">
            <div class="admin-header-left">
                <button class="mobile-menu-btn" id="mobile-menu-btn">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <div class="admin-brand">
                    <span class="admin-brand-name">Abhi's Craftsoft</span>
                </div>
            </div>
            <div class="admin-header-right">
                <!-- Account Panel will be rendered here -->
                <div id="account-panel-container"></div>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="admin-sidebar" id="admin-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-handle"></div>
            </div>
            <nav class="sidebar-nav">
                <a href="#dashboard" class="sidebar-item active" data-section="dashboard">
                    <i class="fa-solid fa-chart-pie"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#students" class="sidebar-item" data-section="students">
                    <i class="fa-solid fa-user-graduate"></i>
                    <span>Students</span>
                </a>
                <a href="#tutors" class="sidebar-item" data-section="tutors">
                    <i class="fa-solid fa-chalkboard-user"></i>
                    <span>Tutors</span>
                </a>
                <a href="#inquiries" class="sidebar-item" data-section="inquiries">
                    <i class="fa-solid fa-envelope-open-text"></i>
                    <span>Inquiries</span>
                </a>
                <a href="#courses" class="sidebar-item" data-section="courses">
                    <i class="fa-solid fa-book-bookmark"></i>
                    <span>Courses</span>
                </a>

                <!-- Payments with Submenu -->
                <div class="sidebar-group">
                    <a href="#payments" class="sidebar-item has-submenu" data-section="payments">
                        <i class="fa-solid fa-money-bill-transfer"></i>
                        <span>Payments</span>
                        <i class="fa-solid fa-chevron-down submenu-arrow"></i>
                    </a>
                    <div class="sidebar-submenu">
                        <a href="#receipts" class="sidebar-subitem" data-section="receipts">
                            <i class="fa-solid fa-file-invoice"></i>
                            <span>Receipts</span>
                        </a>
                    </div>
                </div>

                <a href="#settings" class="sidebar-item" data-section="settings">
                    <i class="fa-solid fa-gear"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </aside>

        <!-- Sidebar Overlay (Mobile) -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="content-card" id="content-area">
                <!-- Content loaded by JavaScript -->
            </div>
        </main>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/admin-utils.js"></script>
    <script src="js/auth.js"></script>

    <script>
        // Section data with purposes
        const sections = {
            dashboard: {
                icon: 'fa-chart-pie',
                title: 'Dashboard',
                purpose: 'High-level overview of institute activity'
            },
            students: {
                icon: 'fa-user-graduate',
                title: 'Students',
                purpose: 'Manage student records and enrollments'
            },
            tutors: {
                icon: 'fa-chalkboard-user',
                title: 'Tutors',
                purpose: 'Manage tutor profiles and assignments'
            },
            inquiries: {
                icon: 'fa-envelope-open-text',
                title: 'Inquiries',
                purpose: 'View and manage contact form submissions'
            },
            courses: {
                icon: 'fa-book-bookmark',
                title: 'Courses',
                purpose: 'Course catalog and curriculum management'
            },
            receipts: {
                icon: 'fa-file-invoice',
                title: 'Receipts',
                purpose: 'Generate and manage payment receipts'
            },
            settings: {
                icon: 'fa-gear',
                title: 'Settings',
                purpose: 'Admin settings and preferences'
            }
        };

        // Render section content
        function renderSection(sectionId) {
            const section = sections[sectionId];
            if (!section) return;

            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fa-solid ${section.icon}"></i>
                    </div>
                    <h1 class="section-title">${section.title}</h1>
                </div>
                <div class="section-divider"></div>
                <div class="section-maintenance">
                    <div class="maintenance-icon">
                        <i class="fa-solid fa-wrench"></i>
                    </div>
                    <h2 class="maintenance-title">Under Maintenance</h2>
                    <p class="maintenance-purpose">
                        <strong>Purpose:</strong> ${section.purpose}
                    </p>
                </div>
            `;

            // Update active state in sidebar
            document.querySelectorAll('.sidebar-item, .sidebar-subitem').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section === sectionId) {
                    item.classList.add('active');
                }
            });

            // If receipts is selected, expand payments submenu
            if (sectionId === 'receipts') {
                document.querySelector('.sidebar-group')?.classList.add('expanded');
            }

            window.location.hash = sectionId;
        }

        // Close account dropdown (for mutual exclusion)
        function closeAccountDropdown() {
            const accountDropdown = document.getElementById('account-dropdown');
            const accountTrigger = document.getElementById('account-trigger');
            if (accountDropdown) accountDropdown.classList.remove('open');
            if (accountTrigger) accountTrigger.classList.remove('open');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const { Toast, Modal, NavigationSecurity, AccountManager, SessionTimeout } = window.AdminUtils;

            // Initialize navigation security
            NavigationSecurity.initProtectedPage();

            // Check authentication
            const session = await window.supabaseConfig.getSession();

            if (!session) {
                NavigationSecurity.secureRedirect('/admin/login.html');
                return;
            }

            // Get admin details
            const admin = await window.Auth.getCurrentAdmin();

            if (!admin || admin.status !== 'ACTIVE') {
                Toast.error('Access Denied', 'Your account is not active');
                await NavigationSecurity.secureLogout();
                return;
            }

            // Add account to manager
            AccountManager.addAccount({
                id: session.user.id,
                admin_id: admin.admin_id,
                email: admin.email,
                full_name: admin.full_name,
                initials: AccountManager.getInitials(admin.full_name)
            }, true);

            AccountManager.storeSession(session.user.id, session);
            AccountManager.renderAccountPanel('account-panel-container');

            // Initialize session timeout
            SessionTimeout.init();

            // Mobile menu toggle
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const sidebar = document.getElementById('admin-sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');

            function openSidebar() {
                closeAccountDropdown(); // Mutual exclusion
                sidebar.classList.add('open');
                sidebarOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            function closeSidebar() {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }

            // Expose closeSidebar globally for account panel
            window.closeSidebar = closeSidebar;

            mobileMenuBtn.addEventListener('click', openSidebar);
            sidebarOverlay.addEventListener('click', closeSidebar);

            // Payments submenu toggle
            const paymentsItem = document.querySelector('.sidebar-item.has-submenu');
            const sidebarGroup = document.querySelector('.sidebar-group');

            // Payments is just a toggle for submenu (not a page)
            if (paymentsItem && sidebarGroup) {
                paymentsItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    sidebarGroup.classList.toggle('expanded');
                });
            }

            // Sidebar navigation (excluding Payments which is just a toggle)
            document.querySelectorAll('.sidebar-item:not(.has-submenu), .sidebar-subitem').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = item.dataset.section;
                    renderSection(sectionId);
                    closeSidebar();
                });
            });

            // Load initial section from hash or default to dashboard
            const initialSection = window.location.hash.slice(1) || 'dashboard';
            renderSection(sections[initialSection] ? initialSection : 'dashboard');

            // Handle hash changes
            window.addEventListener('hashchange', () => {
                const sectionId = window.location.hash.slice(1);
                if (sections[sectionId]) {
                    renderSection(sectionId);
                }
            });

            // Auth state changes
            window.supabaseConfig.onAuthStateChange((event, newSession) => {
                if (event === 'SIGNED_OUT') {
                    NavigationSecurity.secureRedirect('/admin/login.html');
                }
            });
        });
    </script>
</body>

</html>