<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Abhi's Craftsoft</title>
    <meta name="description" content="Admin Dashboard - Abhi's Craftsoft">
    <meta name="robots" content="noindex, nofollow">

    <!-- Security: No Cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Admin Styles -->
    <link rel="stylesheet" href="css/admin.css">
</head>

<body>
    <div class="admin-layout">
        <!-- Header -->
        <header class="admin-header">
            <div class="admin-header-left">
                <button class="mobile-menu-btn" id="mobile-menu-btn">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <div class="admin-brand">
                    <span class="admin-brand-name">Abhi's Craftsoft</span>
                </div>
            </div>
            <div class="admin-header-right">
                <!-- Account Panel will be rendered here -->
                <div id="account-panel-container"></div>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="admin-sidebar" id="admin-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-handle"></div>
            </div>
            <nav class="sidebar-nav">
                <a href="#dashboard" class="sidebar-item active" data-section="dashboard">
                    <i class="fa-solid fa-chart-pie"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#students" class="sidebar-item" data-section="students">
                    <i class="fa-solid fa-user-graduate"></i>
                    <span>Students</span>
                </a>
                <a href="#tutors" class="sidebar-item" data-section="tutors">
                    <i class="fa-solid fa-chalkboard-user"></i>
                    <span>Tutors</span>
                </a>
                <a href="#inquiries" class="sidebar-item" data-section="inquiries">
                    <i class="fa-solid fa-envelope-open-text"></i>
                    <span>Inquiries</span>
                </a>
                <a href="#courses" class="sidebar-item" data-section="courses">
                    <i class="fa-solid fa-book-bookmark"></i>
                    <span>Courses</span>
                </a>

                <!-- Payments with Submenu -->
                <div class="sidebar-group">
                    <a href="#payments" class="sidebar-item has-submenu" data-section="payments">
                        <i class="fa-solid fa-money-bill-transfer"></i>
                        <span>Payments</span>
                        <i class="fa-solid fa-chevron-down submenu-arrow"></i>
                    </a>
                    <div class="sidebar-submenu">
                        <a href="#receipts" class="sidebar-subitem" data-section="receipts">
                            <i class="fa-solid fa-file-invoice"></i>
                            <span>Receipts</span>
                        </a>
                    </div>
                </div>

                <a href="#settings" class="sidebar-item" data-section="settings">
                    <i class="fa-solid fa-gear"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </aside>

        <!-- Sidebar Overlay (Mobile) -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="content-card" id="content-area">
                <!-- Content loaded by JavaScript -->
            </div>
        </main>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/admin-utils.js"></script>
    <script src="js/auth.js"></script>

    <script>
        // Section data with purposes
        const sections = {
            dashboard: {
                icon: 'fa-chart-pie',
                title: 'Dashboard',
                purpose: 'High-level overview of institute activity'
            },
            students: {
                icon: 'fa-user-graduate',
                title: 'Students',
                purpose: 'Manage student records and enrollments'
            },
            tutors: {
                icon: 'fa-chalkboard-user',
                title: 'Tutors',
                purpose: 'Manage tutor profiles and assignments'
            },
            inquiries: {
                icon: 'fa-envelope-open-text',
                title: 'Inquiries',
                purpose: 'View and manage contact form submissions'
            },
            courses: {
                icon: 'fa-book-bookmark',
                title: 'Courses',
                purpose: 'Course catalog and curriculum management'
            },
            receipts: {
                icon: 'fa-file-invoice',
                title: 'Receipts',
                purpose: 'Generate and manage payment receipts'
            },
            settings: {
                icon: 'fa-gear',
                title: 'Settings',
                purpose: 'Admin settings and preferences'
            }
        };

        // Skeleton HTML
        function getSkeletonHTML() {
            return `
                <div class="skeleton-header">
                    <div class="skeleton skeleton-icon"></div>
                    <div class="skeleton skeleton-title"></div>
                </div>
                <div class="skeleton-divider"></div>
                <div class="skeleton-content">
                    <div class="skeleton skeleton-circle"></div>
                    <div class="skeleton skeleton-text skeleton-text-lg"></div>
                    <div class="skeleton skeleton-text skeleton-text-md"></div>
                    <div class="skeleton skeleton-text skeleton-text-sm"></div>
                </div>
            `;
        }

        // Render section content
        function renderSection(sectionId) {
            const section = sections[sectionId];
            if (!section) return;

            const contentArea = document.getElementById('content-area');

            // Show skeleton first
            contentArea.innerHTML = getSkeletonHTML();

            // Handle special sections
            if (sectionId === 'courses') {
                setTimeout(() => renderCoursesSection(contentArea, section), 300);
            } else if (sectionId === 'tutors') {
                setTimeout(() => renderTutorsSection(contentArea, section), 300);
            } else if (sectionId === 'students') {
                setTimeout(() => renderStudentsSection(contentArea, section), 300);
            } else {
                // Default maintenance view
                setTimeout(() => {
                    contentArea.innerHTML = `
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fa-solid ${section.icon}"></i>
                            </div>
                            <h1 class="section-title">${section.title}</h1>
                        </div>
                        <div class="section-divider"></div>
                        <div class="section-maintenance">
                            <div class="maintenance-icon">
                                <i class="fa-solid fa-wrench"></i>
                            </div>
                            <h2 class="maintenance-title">Under Maintenance</h2>
                            <p class="maintenance-purpose">
                                <strong>Purpose:</strong> ${section.purpose}
                            </p>
                        </div>
                    `;
                }, 300);
            }

            // Update active state in sidebar
            document.querySelectorAll('.sidebar-item, .sidebar-subitem').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section === sectionId) {
                    item.classList.add('active');
                }
            });

            // If receipts is selected, expand payments submenu
            if (sectionId === 'receipts') {
                document.querySelector('.sidebar-group')?.classList.add('expanded');
            }

            window.location.hash = sectionId;
        }

        // ============================================
        // COURSES SECTION
        // ============================================

        // Website courses data (synced from pages/courses.html)
        const websiteCourses = [
            { code: 'GD', name: 'Graphic Design' },
            { code: 'UX', name: 'UI/UX Design' },
            { code: 'MERN', name: 'Full Stack Development (MERN)' },
            { code: 'PYFS', name: 'Python Full Stack Development' },
            { code: 'JAVA', name: 'Java Full Stack Development' },
            { code: 'DSA', name: 'DSA Mastery' },
            { code: 'DA', name: 'Data Analytics' },
            { code: 'SF', name: 'Salesforce Administration' },
            { code: 'PY', name: 'Python Programming' },
            { code: 'REACT', name: 'React JS' },
            { code: 'GIT', name: 'Git & GitHub' },
            { code: 'DEVOPS', name: 'DevOps Engineering' },
            { code: 'AWS', name: 'AWS Cloud Excellence' },
            { code: 'DEVSEC', name: 'DevSecOps' },
            { code: 'AZURE', name: 'Microsoft Azure' },
            { code: 'AUTOPY', name: 'Automation with Python' },
            { code: 'ENG', name: 'Spoken English Mastery' },
            { code: 'SOFT', name: 'Soft Skills Training' },
            { code: 'RESUME', name: 'Resume Writing & Interview Prep' },
            { code: 'HW', name: 'Handwriting Improvement' }
        ];

        // Render courses section
        async function renderCoursesSection(contentArea, section) {
            const { Toast } = window.AdminUtils;

            contentArea.innerHTML = `
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fa-solid ${section.icon}"></i>
                    </div>
                    <h1 class="section-title">${section.title}</h1>
                </div>
                <div class="section-actions">
                    <button class="btn btn-primary" id="sync-courses-btn">
                        <i class="fa-solid fa-rotate"></i>
                        Sync from Website
                    </button>
                </div>
                <div class="section-divider"></div>
                <div id="courses-content">
                    <div class="loading-spinner">
                        <i class="fa-solid fa-spinner fa-spin"></i>
                        Loading courses...
                    </div>
                </div>
            `;

            // Load courses
            await loadCourses();

            // Bind sync button
            document.getElementById('sync-courses-btn')?.addEventListener('click', syncCourses);
        }

        // Load courses from Supabase
        async function loadCourses() {
            const { Toast } = window.AdminUtils;
            const coursesContent = document.getElementById('courses-content');

            try {
                const { data: courses, error } = await window.supabaseClient
                    .from('courses')
                    .select('*')
                    .eq('status', 'ACTIVE')
                    .order('course_id', { ascending: true });

                if (error) throw error;

                if (!courses || courses.length === 0) {
                    // Empty state
                    coursesContent.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fa-solid fa-book-bookmark"></i>
                            </div>
                            <h3>No courses yet</h3>
                            <p>Click "Sync from Website" to populate courses</p>
                        </div>
                    `;
                    return;
                }

                // Render courses table (desktop) / cards (mobile)
                coursesContent.innerHTML = `
                    <div class="data-table-wrapper">
                        <table class="data-table" id="courses-table">
                            <thead>
                                <tr>
                                    <th>Course ID</th>
                                    <th>Code</th>
                                    <th>Course Name</th>
                                    <th>Fee</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${courses.map(course => `
                                    <tr data-id="${course.id}">
                                        <td><span class="badge badge-primary">${course.course_id}</span></td>
                                        <td><strong>${course.course_code}</strong></td>
                                        <td>${course.course_name}</td>
                                        <td class="fee-cell">₹${formatNumber(course.fee || 0)}</td>
                                        <td>
                                            <button class="btn-icon btn-edit" data-id="${course.id}" title="Edit Fee">
                                                <i class="fa-solid fa-pen"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Mobile Cards -->
                    <div class="data-cards" id="courses-cards">
                        ${courses.map(course => `
                            <div class="data-card" data-id="${course.id}">
                                <div class="data-card-header">
                                    <span class="badge badge-primary">${course.course_id}</span>
                                    <span class="data-card-code">${course.course_code}</span>
                                </div>
                                <div class="data-card-body">
                                    <h4>${course.course_name}</h4>
                                    <p class="data-card-fee">₹${formatNumber(course.fee || 0)}</p>
                                </div>
                                <div class="data-card-actions">
                                    <button class="btn btn-sm btn-outline btn-edit" data-id="${course.id}">
                                        <i class="fa-solid fa-pen"></i> Edit Fee
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="table-footer">
                        <span>${courses.length} course${courses.length !== 1 ? 's' : ''} synced from website</span>
                    </div>
                `;

                // Bind edit buttons
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', () => openEditFeeModal(btn.dataset.id));
                });

            } catch (error) {
                console.error('Load courses error:', error);
                coursesContent.innerHTML = `
                    <div class="error-state">
                        <i class="fa-solid fa-exclamation-triangle"></i>
                        <p>Failed to load courses. Please try again.</p>
                    </div>
                `;
            }
        }

        // Sync courses from website
        async function syncCourses() {
            const { Toast } = window.AdminUtils;
            const syncBtn = document.getElementById('sync-courses-btn');

            syncBtn.disabled = true;
            syncBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Syncing...';

            try {
                // Get existing courses
                const { data: existing, error: fetchError } = await window.supabaseClient
                    .from('courses')
                    .select('course_code, fee');

                if (fetchError) throw fetchError;

                const existingMap = new Map(existing?.map(c => [c.course_code, c.fee]) || []);

                // Get max course_id number
                const { data: maxData } = await window.supabaseClient
                    .from('courses')
                    .select('course_id')
                    .order('course_id', { ascending: false })
                    .limit(1);

                let nextNum = 1;
                if (maxData && maxData.length > 0) {
                    const match = maxData[0].course_id.match(/C-(\d+)/);
                    if (match) nextNum = parseInt(match[1]) + 1;
                }

                // Upsert courses
                let synced = 0;
                for (const course of websiteCourses) {
                    const existingFee = existingMap.get(course.code);

                    if (existingFee !== undefined) {
                        // Update existing (keep fee)
                        await window.supabaseClient
                            .from('courses')
                            .update({
                                course_name: course.name,
                                synced_at: new Date().toISOString()
                            })
                            .eq('course_code', course.code);
                    } else {
                        // Insert new
                        const courseId = `C-${String(nextNum).padStart(3, '0')}`;
                        await window.supabaseClient
                            .from('courses')
                            .insert({
                                course_id: courseId,
                                course_code: course.code,
                                course_name: course.name,
                                fee: 0,
                                status: 'ACTIVE'
                            });
                        nextNum++;
                    }
                    synced++;
                }

                Toast.success('Sync Complete', `${synced} courses synced from website`);
                await loadCourses();

            } catch (error) {
                console.error('Sync error:', error);
                Toast.error('Sync Failed', error.message);
            } finally {
                syncBtn.disabled = false;
                syncBtn.innerHTML = '<i class="fa-solid fa-rotate"></i> Sync from Website';
            }
        }

        // Open edit fee modal
        async function openEditFeeModal(courseId) {
            const { Toast, Modal } = window.AdminUtils;

            // Fetch course data
            const { data: course, error } = await window.supabaseClient
                .from('courses')
                .select('*')
                .eq('id', courseId)
                .single();

            if (error || !course) {
                Toast.error('Error', 'Could not load course data');
                return;
            }

            // Create modal
            const modalHTML = `
                <div class="modal-overlay active" id="edit-fee-modal">
                    <div class="modal-container">
                        <div class="modal-header">
                            <h3>Edit Course Fee</h3>
                            <button class="modal-close" id="close-fee-modal">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Course ID</label>
                                <input type="text" value="${course.course_id}" disabled class="input-locked">
                            </div>
                            <div class="form-group">
                                <label>Course Code</label>
                                <input type="text" value="${course.course_code}" disabled class="input-locked">
                            </div>
                            <div class="form-group">
                                <label>Course Name</label>
                                <input type="text" value="${course.course_name}" disabled class="input-locked">
                            </div>
                            <div class="form-group">
                                <label>Fee (₹) <span class="required">*</span></label>
                                <input type="number" id="edit-fee-input" value="${course.fee || 0}" min="0" step="100">
                                <span class="input-hint">Enter 0 if fee is not yet decided</span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" id="cancel-fee-btn">Cancel</button>
                            <button class="btn btn-primary" id="save-fee-btn">
                                <i class="fa-solid fa-check"></i> Update Fee
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.body.style.overflow = 'hidden';

            const modal = document.getElementById('edit-fee-modal');
            const closeBtn = document.getElementById('close-fee-modal');
            const cancelBtn = document.getElementById('cancel-fee-btn');
            const saveBtn = document.getElementById('save-fee-btn');
            const feeInput = document.getElementById('edit-fee-input');

            const closeModal = () => {
                modal.remove();
                document.body.style.overflow = '';
            };

            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            saveBtn.addEventListener('click', async () => {
                const newFee = parseFloat(feeInput.value) || 0;

                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

                try {
                    const { error } = await window.supabaseClient
                        .from('courses')
                        .update({ fee: newFee })
                        .eq('id', courseId);

                    if (error) throw error;

                    Toast.success('Updated', 'Course fee updated successfully');
                    closeModal();
                    await loadCourses();

                } catch (error) {
                    console.error('Update fee error:', error);
                    Toast.error('Error', 'Failed to update fee');
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fa-solid fa-check"></i> Update Fee';
                }
            });
        }

        // Format number with commas
        function formatNumber(num) {
            return num.toLocaleString('en-IN');
        }

        // ============================================
        // TUTORS SECTION
        // ============================================

        let allTutors = [];
        let allCoursesForTutors = [];

        // Render tutors section
        async function renderTutorsSection(contentArea, section) {
            contentArea.innerHTML = `
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fa-solid ${section.icon}"></i>
                    </div>
                    <h1 class="section-title">${section.title}</h1>
                </div>
                <div class="section-actions">
                    <button class="btn btn-primary" id="add-tutor-btn">
                        <i class="fa-solid fa-plus"></i>
                        Add Tutor
                    </button>
                    <div class="search-box">
                        <i class="fa-solid fa-search"></i>
                        <input type="text" id="tutor-search" placeholder="Search tutors...">
                    </div>
                </div>
                <div class="section-divider"></div>
                <div id="tutors-content">
                    <div class="loading-spinner">
                        <i class="fa-solid fa-spinner fa-spin"></i>
                        Loading tutors...
                    </div>
                </div>
            `;

            // Load courses first (for multi-select)
            await loadCoursesForTutors();

            // Load tutors
            await loadTutors();

            // Bind add button
            document.getElementById('add-tutor-btn')?.addEventListener('click', () => openTutorModal());

            // Bind search
            document.getElementById('tutor-search')?.addEventListener('input', (e) => {
                filterTutors(e.target.value);
            });
        }

        // Load courses for tutor form
        async function loadCoursesForTutors() {
            const { data, error } = await window.supabaseClient
                .from('courses')
                .select('course_code, course_name')
                .eq('status', 'ACTIVE')
                .order('course_code');

            if (!error && data) {
                allCoursesForTutors = data;
            }
        }

        // Load tutors from Supabase
        async function loadTutors() {
            const { Toast } = window.AdminUtils;
            const tutorsContent = document.getElementById('tutors-content');

            try {
                const { data: tutors, error } = await window.supabaseClient
                    .from('tutors')
                    .select('*')
                    .eq('status', 'ACTIVE')
                    .order('tutor_id', { ascending: true });

                if (error) throw error;

                allTutors = tutors || [];
                renderTutorsList(allTutors);

            } catch (error) {
                console.error('Load tutors error:', error);
                tutorsContent.innerHTML = `
                    <div class="error-state">
                        <i class="fa-solid fa-exclamation-triangle"></i>
                        <p>Failed to load tutors. Please try again.</p>
                    </div>
                `;
            }
        }

        // Render tutors list
        function renderTutorsList(tutors) {
            const tutorsContent = document.getElementById('tutors-content');

            if (!tutors || tutors.length === 0) {
                tutorsContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fa-solid fa-chalkboard-user"></i>
                        </div>
                        <h3>No tutors yet</h3>
                        <p>Click "Add Tutor" to add your first tutor</p>
                    </div>
                `;
                return;
            }

            tutorsContent.innerHTML = `
                <div class="data-table-wrapper">
                    <table class="data-table" id="tutors-table">
                        <thead>
                            <tr>
                                <th>Tutor ID</th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Courses</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tutors.map(tutor => `
                                <tr data-id="${tutor.id}">
                                    <td><span class="badge badge-primary">${tutor.tutor_id}</span></td>
                                    <td><strong>${tutor.full_name}</strong></td>
                                    <td>${tutor.phone}</td>
                                    <td>${(tutor.courses || []).join(', ') || '-'}</td>
                                    <td class="actions-cell">
                                        <button class="btn-icon btn-edit-tutor" data-id="${tutor.id}" title="Edit">
                                            <i class="fa-solid fa-pen"></i>
                                        </button>
                                        <button class="btn-icon btn-delete-tutor" data-id="${tutor.id}" data-name="${tutor.full_name}" data-tutor-id="${tutor.tutor_id}" title="Delete">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                        <a href="https://wa.me/91${tutor.phone.replace(/\D/g, '')}" target="_blank" class="btn-icon btn-whatsapp-tutor" title="WhatsApp">
                                            <i class="fa-brands fa-whatsapp"></i>
                                        </a>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <!-- Mobile Cards -->
                <div class="data-cards" id="tutors-cards">
                    ${tutors.map(tutor => `
                        <div class="data-card" data-id="${tutor.id}">
                            <div class="data-card-header">
                                <span class="badge badge-primary">${tutor.tutor_id}</span>
                            </div>
                            <div class="data-card-body">
                                <h4>${tutor.full_name}</h4>
                                <p class="data-card-meta"><i class="fa-solid fa-phone"></i> ${tutor.phone}</p>
                                <p class="data-card-meta"><i class="fa-solid fa-book"></i> ${(tutor.courses || []).join(', ') || 'No courses'}</p>
                            </div>
                            <div class="data-card-actions">
                                <button class="btn btn-sm btn-outline btn-edit-tutor" data-id="${tutor.id}">
                                    <i class="fa-solid fa-pen"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline btn-danger btn-delete-tutor" data-id="${tutor.id}" data-name="${tutor.full_name}" data-tutor-id="${tutor.tutor_id}">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                                <a href="https://wa.me/91${tutor.phone.replace(/\D/g, '')}" target="_blank" class="btn btn-sm btn-whatsapp">
                                    <i class="fa-brands fa-whatsapp"></i>
                                </a>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="table-footer">
                    <span>${tutors.length} tutor${tutors.length !== 1 ? 's' : ''}</span>
                </div>
            `;

            // Bind action buttons
            document.querySelectorAll('.btn-edit-tutor').forEach(btn => {
                btn.addEventListener('click', () => openTutorModal(btn.dataset.id));
            });

            document.querySelectorAll('.btn-delete-tutor').forEach(btn => {
                btn.addEventListener('click', () => openDeleteTutorModal(btn.dataset.id, btn.dataset.name, btn.dataset.tutorId));
            });
        }

        // Filter tutors
        function filterTutors(query) {
            const filtered = allTutors.filter(t =>
                t.full_name.toLowerCase().includes(query.toLowerCase()) ||
                t.phone.includes(query) ||
                t.tutor_id.toLowerCase().includes(query.toLowerCase())
            );
            renderTutorsList(filtered);
        }

        // Open add/edit tutor modal
        async function openTutorModal(tutorId = null) {
            const { Toast } = window.AdminUtils;
            const isEdit = !!tutorId;
            let tutor = null;

            // Reload courses for the select
            await loadCoursesForTutors();

            if (allCoursesForTutors.length === 0) {
                Toast.error('No Courses', 'Please sync courses first before adding tutors');
                return;
            }

            if (isEdit) {
                const { data, error } = await window.supabaseClient
                    .from('tutors')
                    .select('*')
                    .eq('id', tutorId)
                    .single();

                if (error || !data) {
                    Toast.error('Error', 'Could not load tutor data');
                    return;
                }
                tutor = data;
            }

            const coursesCheckboxes = allCoursesForTutors.map(c => `
                <label class="checkbox-item">
                    <input type="checkbox" name="tutor-courses" value="${c.course_code}" 
                        ${tutor && tutor.courses?.includes(c.course_code) ? 'checked' : ''}>
                    <span>${c.course_code} - ${c.course_name}</span>
                </label>
            `).join('');

            const modalHTML = `
                <div class="modal-overlay active" id="tutor-modal">
                    <div class="modal-container">
                        <div class="modal-header">
                            <h3>${isEdit ? 'Edit Tutor' : 'Add Tutor'}</h3>
                            <button class="modal-close" id="close-tutor-modal">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            ${isEdit ? `
                                <div class="form-group">
                                    <label>Tutor ID</label>
                                    <input type="text" value="${tutor.tutor_id}" disabled class="input-locked">
                                </div>
                            ` : ''}
                            <div class="form-group">
                                <label>Name <span class="required">*</span></label>
                                <input type="text" id="tutor-name" value="${tutor?.full_name || ''}" placeholder="Enter full name" required>
                            </div>
                            <div class="form-group">
                                <label>Phone <span class="required">*</span></label>
                                <input type="tel" id="tutor-phone" value="${tutor?.phone || ''}" placeholder="10-digit mobile number" maxlength="10" required>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="tutor-email" value="${tutor?.email || ''}" placeholder="email@example.com">
                            </div>
                            <div class="form-group">
                                <label>LinkedIn URL</label>
                                <input type="url" id="tutor-linkedin" value="${tutor?.linkedin_url || ''}" placeholder="https://linkedin.com/in/...">
                            </div>
                            <div class="form-group">
                                <label>Courses <span class="required">*</span></label>
                                <div class="checkbox-list" id="tutor-courses-list">
                                    ${coursesCheckboxes || '<p class="text-muted">No courses available. Sync courses first.</p>'}
                                </div>
                                <span class="input-hint">Select courses this tutor can teach</span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" id="cancel-tutor-btn">Cancel</button>
                            <button class="btn btn-primary" id="save-tutor-btn">
                                <i class="fa-solid fa-check"></i> ${isEdit ? 'Update Tutor' : 'Save Tutor'}
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.body.style.overflow = 'hidden';

            const modal = document.getElementById('tutor-modal');
            const closeBtn = document.getElementById('close-tutor-modal');
            const cancelBtn = document.getElementById('cancel-tutor-btn');
            const saveBtn = document.getElementById('save-tutor-btn');

            const closeModal = () => {
                modal.remove();
                document.body.style.overflow = '';
            };

            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            saveBtn.addEventListener('click', async () => {
                const name = document.getElementById('tutor-name').value.trim();
                const phone = document.getElementById('tutor-phone').value.trim();
                const email = document.getElementById('tutor-email').value.trim();
                const linkedin = document.getElementById('tutor-linkedin').value.trim();
                const selectedCourses = Array.from(document.querySelectorAll('input[name="tutor-courses"]:checked'))
                    .map(cb => cb.value);

                // Validation
                if (!name) {
                    Toast.error('Required', 'Please enter tutor name');
                    return;
                }
                if (!phone || phone.length !== 10) {
                    Toast.error('Required', 'Please enter valid 10-digit phone');
                    return;
                }
                if (selectedCourses.length === 0) {
                    Toast.error('Required', 'Please select at least one course');
                    return;
                }

                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

                try {
                    if (isEdit) {
                        // Update
                        const { error } = await window.supabaseClient
                            .from('tutors')
                            .update({
                                full_name: name,
                                phone: phone,
                                email: email || null,
                                linkedin_url: linkedin || null,
                                courses: selectedCourses
                            })
                            .eq('id', tutorId);

                        if (error) throw error;
                        Toast.success('Updated', 'Tutor updated successfully');
                    } else {
                        // Generate new tutor ID
                        const { data: maxData } = await window.supabaseClient
                            .from('tutors')
                            .select('tutor_id')
                            .order('tutor_id', { ascending: false })
                            .limit(1);

                        let nextNum = 1;
                        if (maxData && maxData.length > 0) {
                            const match = maxData[0].tutor_id.match(/T-ACS-(\d+)/);
                            if (match) nextNum = parseInt(match[1]) + 1;
                        }
                        const newTutorId = `T-ACS-${String(nextNum).padStart(3, '0')}`;

                        // Insert
                        const { error } = await window.supabaseClient
                            .from('tutors')
                            .insert({
                                tutor_id: newTutorId,
                                full_name: name,
                                phone: phone,
                                email: email || null,
                                linkedin_url: linkedin || null,
                                courses: selectedCourses,
                                status: 'ACTIVE'
                            });

                        if (error) throw error;
                        Toast.success('Added', 'Tutor added successfully');
                    }

                    closeModal();
                    await loadTutors();

                } catch (error) {
                    console.error('Save tutor error:', error);
                    Toast.error('Error', error.message || 'Failed to save tutor');
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = `<i class="fa-solid fa-check"></i> ${isEdit ? 'Update Tutor' : 'Save Tutor'}`;
                }
            });
        }

        // Open delete confirmation modal
        function openDeleteTutorModal(tutorId, tutorName, tutorIdCode) {
            const { Toast } = window.AdminUtils;

            const modalHTML = `
                <div class="modal-overlay active" id="delete-tutor-modal">
                    <div class="modal-container modal-sm">
                        <div class="modal-header">
                            <h3>Delete Tutor</h3>
                            <button class="modal-close" id="close-delete-modal">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                        <div class="modal-body text-center">
                            <div class="warning-icon">
                                <i class="fa-solid fa-triangle-exclamation"></i>
                            </div>
                            <p>Are you sure you want to delete this tutor?</p>
                            <p class="text-strong">${tutorName} (${tutorIdCode})</p>
                            <p class="text-muted">This action cannot be undone.</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" id="cancel-delete-btn">Cancel</button>
                            <button class="btn btn-danger" id="confirm-delete-btn">
                                <i class="fa-solid fa-trash"></i> Delete Tutor
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.body.style.overflow = 'hidden';

            const modal = document.getElementById('delete-tutor-modal');
            const closeBtn = document.getElementById('close-delete-modal');
            const cancelBtn = document.getElementById('cancel-delete-btn');
            const confirmBtn = document.getElementById('confirm-delete-btn');

            const closeModal = () => {
                modal.remove();
                document.body.style.overflow = '';
            };

            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            confirmBtn.addEventListener('click', async () => {
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Deleting...';

                try {
                    const { error } = await window.supabaseClient
                        .from('tutors')
                        .delete()
                        .eq('id', tutorId);

                    if (error) throw error;

                    Toast.success('Deleted', 'Tutor deleted successfully');
                    closeModal();
                    await loadTutors();

                } catch (error) {
                    console.error('Delete tutor error:', error);
                    Toast.error('Error', 'Failed to delete tutor');
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '<i class="fa-solid fa-trash"></i> Delete Tutor';
                }
            });
        }

        // ============================================
        // STUDENTS SECTION
        // ============================================

        let allStudents = [];
        let allCoursesForStudents = [];
        let allTutorsForStudents = [];

        // Render students section
        async function renderStudentsSection(contentArea, section) {
            contentArea.innerHTML = `
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fa-solid ${section.icon}"></i>
                    </div>
                    <h1 class="section-title">${section.title}</h1>
                </div>
                <div class="section-actions">
                    <button class="btn btn-primary" id="add-student-btn">
                        <i class="fa-solid fa-plus"></i>
                        Add Student
                    </button>
                    <div class="search-box">
                        <i class="fa-solid fa-search"></i>
                        <input type="text" id="student-search" placeholder="Search students...">
                    </div>
                </div>
                <div class="section-divider"></div>
                <div id="students-content">
                    <div class="loading-spinner">
                        <i class="fa-solid fa-spinner fa-spin"></i>
                        Loading students...
                    </div>
                </div>
            `;

            // Load data
            await loadCoursesForStudents();
            await loadTutorsForStudents();
            await loadStudents();

            // Bind add button
            document.getElementById('add-student-btn')?.addEventListener('click', () => openStudentModal());

            // Bind search
            document.getElementById('student-search')?.addEventListener('input', (e) => {
                filterStudents(e.target.value);
            });
        }

        // Load courses for student form
        async function loadCoursesForStudents() {
            const { data, error } = await window.supabaseClient
                .from('courses')
                .select('course_code, course_name')
                .eq('status', 'ACTIVE')
                .order('course_code');

            if (!error && data) {
                allCoursesForStudents = data;
            }
        }

        // Load tutors for student form
        async function loadTutorsForStudents() {
            const { data, error } = await window.supabaseClient
                .from('tutors')
                .select('tutor_id, full_name, courses')
                .eq('status', 'ACTIVE')
                .order('tutor_id');

            if (!error && data) {
                allTutorsForStudents = data;
            }
        }

        // Load students from Supabase
        async function loadStudents() {
            const { Toast } = window.AdminUtils;
            const studentsContent = document.getElementById('students-content');

            try {
                const { data: students, error } = await window.supabaseClient
                    .from('students')
                    .select('*')
                    .eq('status', 'ACTIVE')
                    .order('student_id', { ascending: true });

                if (error) throw error;

                allStudents = students || [];
                renderStudentsList(allStudents);

            } catch (error) {
                console.error('Load students error:', error);
                studentsContent.innerHTML = `
                    <div class="error-state">
                        <i class="fa-solid fa-exclamation-triangle"></i>
                        <p>Failed to load students. Please try again.</p>
                    </div>
                `;
            }
        }

        // Get tutor name by ID
        function getTutorName(tutorId) {
            const tutor = allTutorsForStudents.find(t => t.tutor_id === tutorId);
            return tutor ? tutor.full_name : tutorId;
        }

        // Render students list
        function renderStudentsList(students) {
            const studentsContent = document.getElementById('students-content');

            if (!students || students.length === 0) {
                studentsContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fa-solid fa-user-graduate"></i>
                        </div>
                        <h3>No students yet</h3>
                        <p>Click "Add Student" to enroll your first student</p>
                    </div>
                `;
                return;
            }

            studentsContent.innerHTML = `
                <div class="data-table-wrapper">
                    <table class="data-table" id="students-table">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Course(s)</th>
                                <th>Tutor(s)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${students.map(student => `
                                <tr data-id="${student.id}">
                                    <td><span class="badge badge-primary">${student.student_id}</span></td>
                                    <td><strong>${student.first_name} ${student.last_name}</strong></td>
                                    <td>${student.phone}</td>
                                    <td>${(student.courses || []).join(', ') || '-'}</td>
                                    <td>${(student.tutors || []).map(t => getTutorName(t)).join(', ') || '-'}</td>
                                    <td class="actions-cell">
                                        <button class="btn-icon btn-edit-student" data-id="${student.id}" title="Edit">
                                            <i class="fa-solid fa-pen"></i>
                                        </button>
                                        <button class="btn-icon btn-delete-student" data-id="${student.id}" data-name="${student.first_name} ${student.last_name}" data-student-id="${student.student_id}" title="Delete">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                        <a href="https://wa.me/91${student.phone.replace(/\D/g, '')}" target="_blank" class="btn-icon btn-whatsapp-student" title="WhatsApp">
                                            <i class="fa-brands fa-whatsapp"></i>
                                        </a>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <!-- Mobile Cards -->
                <div class="data-cards" id="students-cards">
                    ${students.map(student => `
                        <div class="data-card" data-id="${student.id}">
                            <div class="data-card-header">
                                <span class="badge badge-primary">${student.student_id}</span>
                            </div>
                            <div class="data-card-body">
                                <h4>${student.first_name} ${student.last_name}</h4>
                                <p class="data-card-meta"><i class="fa-solid fa-phone"></i> ${student.phone}</p>
                                <p class="data-card-meta"><i class="fa-solid fa-book"></i> ${(student.courses || []).join(', ') || 'No courses'}</p>
                                <p class="data-card-meta"><i class="fa-solid fa-chalkboard-user"></i> ${(student.tutors || []).map(t => getTutorName(t)).join(', ') || 'No tutor'}</p>
                            </div>
                            <div class="data-card-actions">
                                <button class="btn btn-sm btn-outline btn-edit-student" data-id="${student.id}">
                                    <i class="fa-solid fa-pen"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline btn-danger btn-delete-student" data-id="${student.id}" data-name="${student.first_name} ${student.last_name}" data-student-id="${student.student_id}">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                                <a href="https://wa.me/91${student.phone.replace(/\D/g, '')}" target="_blank" class="btn btn-sm btn-whatsapp">
                                    <i class="fa-brands fa-whatsapp"></i>
                                </a>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="table-footer">
                    <span>${students.length} student${students.length !== 1 ? 's' : ''}</span>
                </div>
            `;

            // Bind action buttons
            document.querySelectorAll('.btn-edit-student').forEach(btn => {
                btn.addEventListener('click', () => openStudentModal(btn.dataset.id));
            });

            document.querySelectorAll('.btn-delete-student').forEach(btn => {
                btn.addEventListener('click', () => openDeleteStudentModal(btn.dataset.id, btn.dataset.name, btn.dataset.studentId));
            });
        }

        // Filter students
        function filterStudents(query) {
            const filtered = allStudents.filter(s =>
                `${s.first_name} ${s.last_name}`.toLowerCase().includes(query.toLowerCase()) ||
                s.phone.includes(query) ||
                s.student_id.toLowerCase().includes(query.toLowerCase())
            );
            renderStudentsList(filtered);
        }

        // Get filtered tutors based on selected courses
        function getFilteredTutors(selectedCourses) {
            if (!selectedCourses || selectedCourses.length === 0) {
                return [];
            }
            return allTutorsForStudents.filter(tutor =>
                tutor.courses && tutor.courses.some(c => selectedCourses.includes(c))
            );
        }

        // Update tutor checkboxes based on selected courses
        function updateTutorCheckboxes(selectedCourses, existingTutorIds = []) {
            const tutorsList = document.getElementById('student-tutors-list');
            if (!tutorsList) return;

            if (!selectedCourses || selectedCourses.length === 0) {
                tutorsList.innerHTML = '<p class="text-muted">Select courses first to see available tutors</p>';
                return;
            }

            const filteredTutors = getFilteredTutors(selectedCourses);

            if (filteredTutors.length === 0) {
                tutorsList.innerHTML = '<p class="text-muted">No tutors available for selected courses</p>';
                return;
            }

            tutorsList.innerHTML = filteredTutors.map(t => `
                <label class="checkbox-item">
                    <input type="checkbox" name="student-tutors" value="${t.tutor_id}" 
                        ${existingTutorIds.includes(t.tutor_id) ? 'checked' : ''}>
                    <span>${t.tutor_id} - ${t.full_name} (${t.courses.join(', ')})</span>
                </label>
            `).join('');
        }

        // Open add/edit student modal
        async function openStudentModal(studentId = null) {
            const { Toast } = window.AdminUtils;
            const isEdit = !!studentId;
            let student = null;

            // Reload data
            await loadCoursesForStudents();
            await loadTutorsForStudents();

            if (allCoursesForStudents.length === 0) {
                Toast.error('No Courses', 'Please sync courses first before adding students');
                return;
            }

            if (allTutorsForStudents.length === 0) {
                Toast.error('No Tutors', 'Please add tutors first before adding students');
                return;
            }

            if (isEdit) {
                const { data, error } = await window.supabaseClient
                    .from('students')
                    .select('*')
                    .eq('id', studentId)
                    .single();

                if (error || !data) {
                    Toast.error('Error', 'Could not load student data');
                    return;
                }
                student = data;
            }

            const coursesCheckboxes = allCoursesForStudents.map(c => `
                <label class="checkbox-item">
                    <input type="checkbox" name="student-courses" value="${c.course_code}" 
                        ${student && student.courses?.includes(c.course_code) ? 'checked' : ''}>
                    <span>${c.course_code} - ${c.course_name}</span>
                </label>
            `).join('');

            const modalHTML = `
                <div class="modal-overlay active" id="student-modal">
                    <div class="modal-container modal-lg">
                        <div class="modal-header">
                            <h3>${isEdit ? 'Edit Student' : 'Add Student'}</h3>
                            <button class="modal-close" id="close-student-modal">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            ${isEdit ? `
                                <div class="form-group">
                                    <label>Student ID</label>
                                    <input type="text" value="${student.student_id}" disabled class="input-locked">
                                </div>
                            ` : ''}
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>First Name <span class="required">*</span></label>
                                    <input type="text" id="student-fname" value="${student?.first_name || ''}" placeholder="First name" required>
                                </div>
                                <div class="form-group">
                                    <label>Last Name <span class="required">*</span></label>
                                    <input type="text" id="student-lname" value="${student?.last_name || ''}" placeholder="Last name" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Phone <span class="required">*</span></label>
                                    <input type="tel" id="student-phone" value="${student?.phone || ''}" placeholder="10-digit number" maxlength="10" required>
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="student-email" value="${student?.email || ''}" placeholder="email@example.com">
                                </div>
                            </div>
                            
                            <div class="form-section-title">Enrollment</div>
                            
                            <div class="form-group">
                                <label>Course(s) <span class="required">*</span></label>
                                <div class="checkbox-list" id="student-courses-list">
                                    ${coursesCheckboxes}
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Assigned Tutor(s) <span class="required">*</span></label>
                                <div class="checkbox-list" id="student-tutors-list">
                                    <p class="text-muted">Select courses first to see available tutors</p>
                                </div>
                                <span class="input-hint">Only tutors who teach selected courses are shown</span>
                            </div>
                            
                            <div class="form-section-title">Demo</div>
                            
                            <div class="form-group">
                                <label>Demo Scheduled?</label>
                                <div class="radio-group">
                                    <label class="radio-item">
                                        <input type="radio" name="demo-scheduled" value="yes" ${student?.demo_scheduled ? 'checked' : ''}>
                                        <span>Yes</span>
                                    </label>
                                    <label class="radio-item">
                                        <input type="radio" name="demo-scheduled" value="no" ${!student?.demo_scheduled ? 'checked' : ''}>
                                        <span>No</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-row demo-fields" style="${student?.demo_scheduled ? '' : 'display: none;'}">
                                <div class="form-group">
                                    <label>Demo Date</label>
                                    <input type="date" id="student-demo-date" value="${student?.demo_date || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Demo Time</label>
                                    <input type="text" id="student-demo-time" value="${student?.demo_time || ''}" placeholder="e.g., 6:00 PM">
                                </div>
                            </div>
                            
                            <div class="form-section-title">Batch</div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Joining Date</label>
                                    <input type="date" id="student-joining-date" value="${student?.joining_date || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Batch Time</label>
                                    <input type="text" id="student-batch-time" value="${student?.batch_time || ''}" placeholder="e.g., 7:00 - 8:30 PM">
                                </div>
                            </div>
                            
                            <div class="form-section-title">Fee</div>
                            
                            <div class="form-row form-row-3">
                                <div class="form-group">
                                    <label>Fee (₹)</label>
                                    <input type="number" id="student-fee" value="${student?.fee || 0}" min="0" step="100">
                                </div>
                                <div class="form-group">
                                    <label>Discount (₹)</label>
                                    <input type="number" id="student-discount" value="${student?.discount || 0}" min="0" step="100">
                                </div>
                                <div class="form-group">
                                    <label>Final Fee (₹)</label>
                                    <input type="number" id="student-final-fee" value="${student?.final_fee || 0}" disabled class="input-locked">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea id="student-notes" rows="3" placeholder="Additional notes about the student...">${student?.notes || ''}</textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" id="cancel-student-btn">Cancel</button>
                            <button class="btn btn-primary" id="save-student-btn">
                                <i class="fa-solid fa-check"></i> ${isEdit ? 'Update Student' : 'Save Student'}
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.body.style.overflow = 'hidden';

            const modal = document.getElementById('student-modal');
            const closeBtn = document.getElementById('close-student-modal');
            const cancelBtn = document.getElementById('cancel-student-btn');
            const saveBtn = document.getElementById('save-student-btn');

            // Initialize tutor list based on current courses
            if (student?.courses?.length > 0) {
                updateTutorCheckboxes(student.courses, student.tutors || []);
            }

            // Handle course checkbox changes
            document.querySelectorAll('input[name="student-courses"]').forEach(cb => {
                cb.addEventListener('change', () => {
                    const selectedCourses = Array.from(document.querySelectorAll('input[name="student-courses"]:checked'))
                        .map(c => c.value);
                    const currentTutors = Array.from(document.querySelectorAll('input[name="student-tutors"]:checked'))
                        .map(t => t.value);
                    updateTutorCheckboxes(selectedCourses, currentTutors);
                });
            });

            // Handle demo radio change
            document.querySelectorAll('input[name="demo-scheduled"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const demoFields = document.querySelector('.demo-fields');
                    if (e.target.value === 'yes') {
                        demoFields.style.display = '';
                    } else {
                        demoFields.style.display = 'none';
                    }
                });
            });

            // Handle fee calculation
            const feeInput = document.getElementById('student-fee');
            const discountInput = document.getElementById('student-discount');
            const finalFeeInput = document.getElementById('student-final-fee');

            const calculateFinalFee = () => {
                const fee = parseFloat(feeInput.value) || 0;
                const discount = parseFloat(discountInput.value) || 0;
                finalFeeInput.value = Math.max(0, fee - discount);
            };

            feeInput.addEventListener('input', calculateFinalFee);
            discountInput.addEventListener('input', calculateFinalFee);

            const closeModal = () => {
                modal.remove();
                document.body.style.overflow = '';
            };

            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            saveBtn.addEventListener('click', async () => {
                const fname = document.getElementById('student-fname').value.trim();
                const lname = document.getElementById('student-lname').value.trim();
                const phone = document.getElementById('student-phone').value.trim();
                const email = document.getElementById('student-email').value.trim();
                const selectedCourses = Array.from(document.querySelectorAll('input[name="student-courses"]:checked'))
                    .map(cb => cb.value);
                const selectedTutors = Array.from(document.querySelectorAll('input[name="student-tutors"]:checked'))
                    .map(cb => cb.value);
                const demoScheduled = document.querySelector('input[name="demo-scheduled"]:checked')?.value === 'yes';
                const demoDate = document.getElementById('student-demo-date').value || null;
                const demoTime = document.getElementById('student-demo-time').value.trim() || null;
                const joiningDate = document.getElementById('student-joining-date').value || null;
                const batchTime = document.getElementById('student-batch-time').value.trim() || null;
                const fee = parseFloat(document.getElementById('student-fee').value) || 0;
                const discount = parseFloat(document.getElementById('student-discount').value) || 0;
                const finalFee = Math.max(0, fee - discount);
                const notes = document.getElementById('student-notes').value.trim() || null;

                // Validation
                if (!fname || !lname) {
                    Toast.error('Required', 'Please enter student name');
                    return;
                }
                if (!phone || phone.length !== 10) {
                    Toast.error('Required', 'Please enter valid 10-digit phone');
                    return;
                }
                if (selectedCourses.length === 0) {
                    Toast.error('Required', 'Please select at least one course');
                    return;
                }
                if (selectedTutors.length === 0) {
                    Toast.error('Required', 'Please select at least one tutor');
                    return;
                }

                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

                try {
                    if (isEdit) {
                        // Update
                        const { error } = await window.supabaseClient
                            .from('students')
                            .update({
                                first_name: fname,
                                last_name: lname,
                                phone: phone,
                                email: email || null,
                                courses: selectedCourses,
                                tutors: selectedTutors,
                                demo_scheduled: demoScheduled,
                                demo_date: demoDate,
                                demo_time: demoTime,
                                joining_date: joiningDate,
                                batch_time: batchTime,
                                fee: fee,
                                discount: discount,
                                final_fee: finalFee,
                                notes: notes
                            })
                            .eq('id', studentId);

                        if (error) throw error;
                        Toast.success('Updated', 'Student updated successfully');
                    } else {
                        // Generate new student ID
                        const { data: maxData } = await window.supabaseClient
                            .from('students')
                            .select('student_id')
                            .order('student_id', { ascending: false })
                            .limit(1);

                        let nextNum = 1;
                        if (maxData && maxData.length > 0) {
                            const match = maxData[0].student_id.match(/St-ACS-(\d+)/);
                            if (match) nextNum = parseInt(match[1]) + 1;
                        }
                        const newStudentId = `St-ACS-${String(nextNum).padStart(3, '0')}`;

                        // Insert
                        const { error } = await window.supabaseClient
                            .from('students')
                            .insert({
                                student_id: newStudentId,
                                first_name: fname,
                                last_name: lname,
                                phone: phone,
                                email: email || null,
                                courses: selectedCourses,
                                tutors: selectedTutors,
                                demo_scheduled: demoScheduled,
                                demo_date: demoDate,
                                demo_time: demoTime,
                                joining_date: joiningDate,
                                batch_time: batchTime,
                                fee: fee,
                                discount: discount,
                                final_fee: finalFee,
                                notes: notes,
                                status: 'ACTIVE'
                            });

                        if (error) throw error;
                        Toast.success('Added', 'Student enrolled successfully');
                    }

                    closeModal();
                    await loadStudents();

                } catch (error) {
                    console.error('Save student error:', error);
                    Toast.error('Error', error.message || 'Failed to save student');
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = `<i class="fa-solid fa-check"></i> ${isEdit ? 'Update Student' : 'Save Student'}`;
                }
            });
        }

        // Open delete confirmation modal
        function openDeleteStudentModal(studentId, studentName, studentIdCode) {
            const { Toast } = window.AdminUtils;

            const modalHTML = `
                <div class="modal-overlay active" id="delete-student-modal">
                    <div class="modal-container modal-sm">
                        <div class="modal-header">
                            <h3>Delete Student</h3>
                            <button class="modal-close" id="close-delete-student-modal">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                        <div class="modal-body text-center">
                            <div class="warning-icon">
                                <i class="fa-solid fa-triangle-exclamation"></i>
                            </div>
                            <p>Are you sure you want to delete this student?</p>
                            <p class="text-strong">${studentName} (${studentIdCode})</p>
                            <p class="text-muted">This action cannot be undone.</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" id="cancel-delete-student-btn">Cancel</button>
                            <button class="btn btn-danger" id="confirm-delete-student-btn">
                                <i class="fa-solid fa-trash"></i> Delete Student
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.body.style.overflow = 'hidden';

            const modal = document.getElementById('delete-student-modal');
            const closeBtn = document.getElementById('close-delete-student-modal');
            const cancelBtn = document.getElementById('cancel-delete-student-btn');
            const confirmBtn = document.getElementById('confirm-delete-student-btn');

            const closeModal = () => {
                modal.remove();
                document.body.style.overflow = '';
            };

            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            confirmBtn.addEventListener('click', async () => {
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Deleting...';

                try {
                    const { error } = await window.supabaseClient
                        .from('students')
                        .delete()
                        .eq('id', studentId);

                    if (error) throw error;

                    Toast.success('Deleted', 'Student deleted successfully');
                    closeModal();
                    await loadStudents();

                } catch (error) {
                    console.error('Delete student error:', error);
                    Toast.error('Error', 'Failed to delete student');
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '<i class="fa-solid fa-trash"></i> Delete Student';
                }
            });
        }

        // Close account dropdown (for mutual exclusion)
        function closeAccountDropdown() {
            const accountDropdown = document.getElementById('account-dropdown');
            const accountTrigger = document.getElementById('account-trigger');
            if (accountDropdown) accountDropdown.classList.remove('open');
            if (accountTrigger) accountTrigger.classList.remove('open');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const { Toast, Modal, NavigationSecurity, AccountManager, SessionTimeout } = window.AdminUtils;

            // Initialize navigation security
            NavigationSecurity.initProtectedPage();

            // Check authentication
            const session = await window.supabaseConfig.getSession();

            if (!session) {
                NavigationSecurity.secureRedirect('/admin/login.html');
                return;
            }

            // Get admin details
            const admin = await window.Auth.getCurrentAdmin();

            if (!admin || admin.status !== 'ACTIVE') {
                Toast.error('Access Denied', 'Your account is not active');
                await NavigationSecurity.secureLogout();
                return;
            }

            // Add account to manager
            AccountManager.addAccount({
                id: session.user.id,
                admin_id: admin.admin_id,
                email: admin.email,
                full_name: admin.full_name,
                initials: AccountManager.getInitials(admin.full_name)
            }, true);

            AccountManager.storeSession(session.user.id, session);
            AccountManager.renderAccountPanel('account-panel-container');

            // Initialize session timeout
            SessionTimeout.init();

            // Mobile menu toggle
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const sidebar = document.getElementById('admin-sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');

            function openSidebar() {
                closeAccountDropdown(); // Mutual exclusion
                sidebar.classList.add('open');
                sidebarOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            function closeSidebar() {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }

            // Expose closeSidebar globally for account panel
            window.closeSidebar = closeSidebar;

            mobileMenuBtn.addEventListener('click', openSidebar);
            sidebarOverlay.addEventListener('click', closeSidebar);

            // Payments submenu toggle
            const paymentsItem = document.querySelector('.sidebar-item.has-submenu');
            const sidebarGroup = document.querySelector('.sidebar-group');

            // Payments is just a toggle for submenu (not a page)
            if (paymentsItem && sidebarGroup) {
                paymentsItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    sidebarGroup.classList.toggle('expanded');
                });
            }

            // Sidebar navigation (excluding Payments which is just a toggle)
            document.querySelectorAll('.sidebar-item:not(.has-submenu), .sidebar-subitem').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = item.dataset.section;
                    renderSection(sectionId);
                    closeSidebar();
                });
            });

            // Load initial section from hash or default to dashboard
            const initialSection = window.location.hash.slice(1) || 'dashboard';
            renderSection(sections[initialSection] ? initialSection : 'dashboard');

            // Handle hash changes
            window.addEventListener('hashchange', () => {
                const sectionId = window.location.hash.slice(1);
                if (sections[sectionId]) {
                    renderSection(sectionId);
                }
            });

            // Auth state changes
            window.supabaseConfig.onAuthStateChange((event, newSession) => {
                if (event === 'SIGNED_OUT') {
                    NavigationSecurity.secureRedirect('/admin/login.html');
                }
            });
        });
    </script>
</body>

</html>