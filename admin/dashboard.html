<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Craft Soft</title>
    <meta name="description" content="Craft Soft Admin Dashboard">
    <meta name="robots" content="noindex, nofollow">

    <!-- Security: No Cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Admin Styles -->
    <link rel="stylesheet" href="css/admin.css">
</head>

<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="dashboard-header-left">
                <span class="dashboard-logo">Craft Soft</span>
                <span class="dashboard-title">Admin Panel</span>
            </div>
            <div class="dashboard-header-right">
                <!-- Account Panel will be rendered here -->
                <div id="account-panel-container"></div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="dashboard-main">
            <div class="dashboard-placeholder">
                <div class="dashboard-placeholder-icon">
                    <i class="fa-solid fa-code"></i>
                </div>
                <h2>Dashboard Under Development</h2>
                <p>We're building something amazing. This section will be expanded with admin features progressively.
                </p>
            </div>
        </main>

        <!-- Footer -->
        <footer class="dashboard-footer">
            Â© 2024 Craft Soft. All rights reserved.
        </footer>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/admin-utils.js"></script>
    <script src="js/auth.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const { Toast, Modal, NavigationSecurity, AccountManager } = window.AdminUtils;

            // Initialize navigation security (back/forward protection)
            NavigationSecurity.initProtectedPage();

            // Check authentication
            const session = await window.supabaseConfig.getSession();

            if (!session) {
                NavigationSecurity.secureRedirect('/admin/login.html');
                return;
            }

            // Get admin details from database
            const admin = await window.Auth.getCurrentAdmin();

            if (!admin || admin.status !== 'ACTIVE') {
                Toast.error('Access Denied', 'Your account is not active');
                await NavigationSecurity.secureLogout();
                return;
            }

            // IMPORTANT: Sync with actual Supabase session
            // This handles the case where user logged in from another tab
            const syncedAccount = AccountManager.syncWithSupabaseSession(session.user.id);

            if (!syncedAccount) {
                // User logged in from another tab - add them to this tab's storage
                AccountManager.addAccount({
                    id: session.user.id,
                    admin_id: admin.admin_id,
                    email: admin.email,
                    full_name: admin.full_name,
                    initials: AccountManager.getInitials(admin.full_name)
                }, true);
            }

            // Store/update session tokens for account switching
            AccountManager.storeSession(session.user.id, session);

            // Render the account panel
            AccountManager.renderAccountPanel('account-panel-container');

            // Listen for auth state changes (from other tabs)
            window.supabaseConfig.onAuthStateChange((event, newSession) => {
                if (event === 'SIGNED_OUT') {
                    NavigationSecurity.secureRedirect('/admin/login.html');
                } else if (event === 'SIGNED_IN' && newSession) {
                    // Another tab signed in - sync and reload
                    const currentAccount = AccountManager.getCurrentAccount();
                    if (currentAccount && currentAccount.id !== newSession.user.id) {
                        // Different user signed in from another tab
                        AccountManager.syncWithSupabaseSession(newSession.user.id);
                        location.reload();
                    }
                }
            });
        });
    </script>
</body>

</html>