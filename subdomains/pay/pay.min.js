const SUPABASE_URL="https://afocbygdakyqtmmrjvmy.supabase.co",SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFmb2NieWdkYWt5cXRtbXJqdm15Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5Mzc5MjksImV4cCI6MjA4MjUxMzkyOX0.L7YerK7umlQ0H9WOCfGzY6AcKVjHs7aDKvXLYcCj-f0";let supabaseClient,currentStudent=null,coursesData=[];function initSecurity(){history.pushState(null,null,location.href),window.addEventListener("popstate",()=>{history.pushState(null,null,location.href)}),document.addEventListener("visibilitychange",()=>{const e=document.getElementById("blur-overlay");if(document.hidden){if(!e){const e=document.createElement("div");e.id="blur-overlay",e.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(245,247,250,0.98);backdrop-filter:blur(20px);z-index:9999;display:flex;align-items:center;justify-content:center;",e.innerHTML='<div style="text-align:center;color:#1a1a2e;"><i class="fa-solid fa-lock" style="font-size:48px;margin-bottom:16px;color:#2896cd;"></i><p style="font-size:16px;">Switch back to continue</p></div>',document.body.appendChild(e)}}else e&&e.remove()}),document.addEventListener("contextmenu",e=>e.preventDefault()),document.addEventListener("keydown",e=>{("F12"===e.key||e.ctrlKey&&e.shiftKey&&("I"===e.key||"J"===e.key)||e.ctrlKey&&"u"===e.key)&&e.preventDefault(),"PrintScreen"===e.key&&navigator.clipboard.writeText("")}),window.addEventListener("beforeunload",()=>{currentStudent=null,coursesData=[]})}function bindEvents(){document.getElementById("lookup-btn").addEventListener("click",lookupStudent),document.getElementById("student-id-input").addEventListener("keypress",e=>{"Enter"===e.key&&lookupStudent()}),document.getElementById("back-btn").addEventListener("click",goBack),document.getElementById("done-btn").addEventListener("click",()=>{window.location.reload()})}async function lookupStudent(){const e=document.getElementById("student-id-input"),t=document.getElementById("lookup-btn"),n=e.value.trim();if(n){t.disabled=!0,t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Looking up...';try{const{data:e,error:a}=await supabaseClient.from("students").select("id, student_id, first_name, last_name, phone, courses, course_discounts").ilike("student_id",n).maybeSingle();if(a)throw a;if(!e)return showToast("Student ID not found. Please check and try again."),t.disabled=!1,void(t.innerHTML='<i class="fa-solid fa-search"></i> Find My Account');currentStudent=e,await loadStudentCourses(e),document.getElementById("step-lookup").style.display="none",document.getElementById("step-pay").style.display="block",document.getElementById("student-name").textContent=`${e.first_name} ${e.last_name}`,document.getElementById("student-id-display").textContent=e.student_id}catch(e){console.error("Lookup error:",e),showToast("Something went wrong. Please try again.")}t.disabled=!1,t.innerHTML='<i class="fa-solid fa-search"></i> Find My Account'}else showToast("Please enter your Student ID")}async function loadStudentCourses(e){const t=e.courses||[];if(0===t.length)return void(document.getElementById("courses-list").innerHTML='\n            <div class="course-card">\n                <p style="color: var(--text-muted); text-align: center;">No courses enrolled.</p>\n            </div>\n        ');const{data:n,error:a}=await supabaseClient.from("courses").select("id, course_code, course_name, fee").in("course_code",t);if(a)throw a;const{data:s,error:o}=await supabaseClient.from("payments").select("course_id, amount_paid").eq("student_id",e.id);if(o)throw o;const i=e.course_discounts||{};coursesData=n.map(e=>{const t=parseFloat(i[e.course_code]||0),n=parseFloat(e.fee||0)-t,a=(s||[]).filter(t=>t.course_id===e.id).reduce((e,t)=>e+parseFloat(t.amount_paid||0),0),o=n-a;return{id:e.id,code:e.course_code,name:e.course_name,totalFee:n,paidAmount:a,balance:o>0?o:0,isPaid:o<=0}}),renderCourses()}function renderCourses(){document.getElementById("courses-list").innerHTML=coursesData.map(e=>`\n        <div class="course-card ${e.isPaid?"paid":""}" data-course-id="${e.id}">\n            <div class="course-name">${e.name}</div>\n            <div class="course-fees">\n                <div class="fee-item">\n                    <span class="label">Total</span>\n                    <span class="value">₹${formatNumber(e.totalFee)}</span>\n                </div>\n                <div class="fee-item">\n                    <span class="label">Paid</span>\n                    <span class="value">₹${formatNumber(e.paidAmount)}</span>\n                </div>\n                <div class="fee-item">\n                    <span class="label">Balance</span>\n                    <span class="value ${e.isPaid?"paid-full":"due"}">\n                        ${e.isPaid?"✓ Paid":"₹"+formatNumber(e.balance)}\n                    </span>\n                </div>\n            </div>\n            ${e.isPaid?'\n                <div class="paid-badge">\n                    <i class="fa-solid fa-check-circle"></i> Fully Paid\n                </div>\n            ':`\n                <div class="course-actions">\n                    <div class="amount-input-wrapper">\n                        <span class="currency">₹</span>\n                        <input type="number" class="amount-input" \n                               id="amount-${e.id}" \n                               value="${e.balance}" \n                               min="1" \n                               max="${e.balance}"\n                               placeholder="Amount">\n                    </div>\n                    <button class="btn-pay" onclick="payForCourse('${e.id}')">\n                        <i class="fa-brands fa-gg"></i> Pay\n                    </button>\n                </div>\n            `}\n        </div>\n    `).join("")}async function payForCourse(e){const t=coursesData.find(t=>t.id===e);if(!t)return;const n=document.getElementById(`amount-${e}`),a=parseFloat(n.value);if(!a||a<=0)return void showToast("Please enter a valid amount");if(a>t.balance)return void showToast("Amount cannot exceed balance due");const s=n.parentElement.nextElementSibling;s.disabled=!0,s.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>';try{const n=await fetch("https://www.craftsoft.co.in/.netlify/functions/create-razorpay-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:a,student_id:currentStudent.id,course_id:e})}),o=await n.json();if(!n.ok||!o.success)throw new Error(o.error||"Failed to create order");const i={key:o.key_id,amount:o.amount,currency:o.currency,order_id:o.order_id,name:"Abhi's Craftsoft",description:`${t.name} Fee`,prefill:{name:`${currentStudent.first_name} ${currentStudent.last_name}`,contact:currentStudent.phone||""},method:{upi:!0,card:!1,netbanking:!1,wallet:!1,emi:!1},theme:{color:"#2896cd"},handler:async function(t){await verifyPayment(t,e)},modal:{ondismiss:function(){s.disabled=!1,s.innerHTML='<i class="fa-brands fa-gg"></i> Pay'}}},d=new Razorpay(i);d.on("payment.failed",function(e){s.disabled=!1,s.innerHTML='<i class="fa-brands fa-gg"></i> Pay',showToast(e.error.description||"Payment failed")}),d.open()}catch(e){console.error("Payment error:",e),showToast(e.message||"Failed to initiate payment"),s.disabled=!1,s.innerHTML='<i class="fa-brands fa-gg"></i> Pay'}}async function verifyPayment(e,t){try{const n=await fetch("https://www.craftsoft.co.in/.netlify/functions/verify-razorpay-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({razorpay_payment_id:e.razorpay_payment_id,razorpay_order_id:e.razorpay_order_id,razorpay_signature:e.razorpay_signature,student_id:currentStudent.id,course_id:t})}),a=await n.json();if(!n.ok||!a.success)throw new Error(a.error||"Payment verification failed");document.getElementById("step-pay").style.display="none",document.getElementById("step-success").style.display="block",document.getElementById("receipt-id").textContent=a.receipt_id,document.getElementById("success-message").textContent=`₹${formatNumber(a.amount_paid)} paid successfully!`}catch(e){console.error("Verify error:",e),showToast(e.message||"Verification failed. Please contact support.")}}function goBack(){document.getElementById("step-pay").style.display="none",document.getElementById("step-lookup").style.display="block",document.getElementById("student-id-input").value="",currentStudent=null,coursesData=[]}function showToast(e){const t=document.getElementById("toast");document.getElementById("toast-message").textContent=e,t.style.display="flex",setTimeout(()=>{t.style.display="none"},3e3)}function formatNumber(e){return new Intl.NumberFormat("en-IN").format(e)}document.addEventListener("DOMContentLoaded",()=>{supabaseClient=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY),bindEvents(),initSecurity()});